name: Publish to PyPI

env:
  PYTHONUTF8: "1"

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: false
        type: string
      publish_to_pypi:
        description: 'Publish to PyPI'
        required: false
        type: boolean
        default: true

jobs:
  publish:
    name: Build and publish to PyPI
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for trusted publishing (OIDC)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for version detection
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Install project dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-mock pytest-cov
      
      - name: Run tests
        run: |
          pytest -v
      
      - name: Build package
        run: |
          python -m build
      
      - name: Check package
        run: |
          twine check dist/*
      
      - name: Publish to PyPI
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.publish_to_pypi == 'true' || github.event.inputs.publish_to_pypi == ''))
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          echo "Uploading package to PyPI..."
          twine upload dist/*
      
      - name: Skip PyPI publishing
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to_pypi == 'false'
        run: |
          echo "Skipping PyPI publishing (publish_to_pypi parameter set to false)"
      
      - name: Upload PyPI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pypi-packages
          path: dist/*.whl
          retention-days: 30

  build-standalone:
    name: Build standalone executables
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            executable: ec2-session-gate
          - os: windows-latest
            platform: windows
            executable: ec2-session-gate.exe
          - os: macos-latest
            platform: macos
            executable: ec2-session-gate.app
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build standalone executable
        run: |
          python build_standalone.py
      
      - name: List build artifacts
        run: |
          python -c "import os, pathlib; dist = pathlib.Path('dist'); print('Contents of dist directory:'); [print(f'  {p}') for p in sorted(dist.rglob('*')) if p.exists()] if dist.exists() else print('  dist directory not found')"
      
      - name: Create release archive (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          if [ -f "dist/ec2-session-gate" ]; then
            tar -czf ec2-session-gate-${{ matrix.platform }}.tar.gz -C dist ec2-session-gate
            echo "Created Linux archive"
          else
            echo "Error: Linux executable not found"
            exit 1
          fi
      
      - name: Create release archive (Windows)
        if: matrix.platform == 'windows'
        shell: powershell
        run: |
          if (Test-Path "dist\ec2-session-gate.exe") {
            Compress-Archive -Path dist\ec2-session-gate.exe -DestinationPath ec2-session-gate-${{ matrix.platform }}.zip -Force
            Write-Host "Created Windows archive"
          } else {
            Write-Host "Error: Windows executable not found"
            exit 1
          }
      
      - name: Create release archive (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          if [ -d "dist/ec2-session-gate.app" ]; then
            cd dist
            zip -r ../ec2-session-gate-${{ matrix.platform }}.zip ec2-session-gate.app
            cd ..
            echo "Created macOS archive"
          else
            echo "Error: macOS app bundle not found"
            exit 1
          fi
      
      - name: Upload standalone executable
        uses: actions/upload-artifact@v4
        with:
          name: standalone-${{ matrix.platform }}-executable
          path: |
            dist/${{ matrix.executable }}
          retention-days: 90
      
      - name: Upload standalone archive
        uses: actions/upload-artifact@v4
        with:
          name: standalone-${{ matrix.platform }}-archive
          path: |
            ec2-session-gate-${{ matrix.platform }}.*
          retention-days: 90
